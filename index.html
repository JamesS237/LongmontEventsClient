<!DOCTYPE html>
<html>
<head>
	<style>
	/*various css*/
	.row {
		padding-left: 15px;
		padding-right: 15px;
	}
	.picker
	{
		font-size: 17px;
	}
	.datepicker {
		background-color:transparent;
		border: 0px solid;
		font-weight: bold;
		margin-bottom: 15px;
	}
	.datepicker textarea:focus, input:focus{
		outline: 0;
	}
	#map-canvas {
        width: 100%;
        height: 500px;
        margin-top: 10px;
    }
    #noeventsfortoday {
    	margin-top: 15px;
    	display: none;
    }
    #eventpage
    {
    	display: none;
    }
    .navbar img
    {
    	margin-right: 10px;
    	border-radius: 100px;
    }
    .navbar .navbar-brand {
        overflow: visible;
        padding-top: 5px;
        padding-bottom: 5px;
    }
    nav
    {
    	margin-bottom: 10px !important;
    }
    .goingcount
    {
    	text-align: center;
    }
    </style>
	<title>Longmont Events</title>
	<meta charset="utf-8">

	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<meta name="apple-mobile-web-app-capable" content="yes">
	<link href="css/bootstrap.min.css" rel="stylesheet" media="screen">
	<link href="css/bootstrap-theme.css" rel="stylesheet">
	<link href="http://code.jquery.com/ui/1.10.3/themes/smoothness/jquery-ui.css" rel="stylesheet">
</head>
<body>
	<nav class="navbar navbar-default" role="navigation">
		<div class="navbar-header">
			<a class="navbar-brand" href="#"> <img src="wheel.png"><b>Longmont Events</b></a>
		</div>
	</nav>
	<div class="container">
		<div id="eventpage">
		<button type="button" id="backbutton" class="btn btn-default"><span class="glyphicon glyphicon-chevron-left"></span> Back</button>
		<h2><span id="title"></span></h2>
		<p id="address">Address: </p>
		<p id="date">Date: </p>
		<p id="description">Description: </p>
		<button id="imgoing" type="button" class="btn btn-warning btn-lg btn-block"><span id="star" class="glyphicon glyphicon-star-empty"></span> I'm Going!</button>
		<p class="goingcount"><span id="goingcount"></span></p><hr>
		<div id="fb-root"></div>
<!--<script>(function(d, s, id) {
  var js, fjs = d.getElementsByTagName(s)[0];
  if (d.getElementById(id)) return;
  js = d.createElement(s); js.id = id;
  js.src = "//connect.facebook.net/en_US/all.js#xfbml=1";
  fjs.parentNode.insertBefore(js, fjs);
}(document, 'script', 'facebook-jssdk'));</script>
<div class="fb-like" data-href="https://developers.facebook.com/docs/plugins/" data-layout="standard" data-action="like" data-show-faces="true" data-share="true"></div><br>
<a href="https://twitter.com/share" class="twitter-share-button" data-via="Jaxkr_">Tweet</a>
<script>!function(d,s,id){var js,fjs=d.getElementsByTagName(s)[0],p=/^http:/.test(d.location)?'http':'https';if(!d.getElementById(id)){js=d.createElement(s);js.id=id;js.src=p+'://platform.twitter.com/widgets.js';fjs.parentNode.insertBefore(js,fjs);}}(document, 'script', 'twitter-wjs');</script>-->
		</div>
		<div class="row">
			<span class="picker">Showing events for<br><span id="cal" class="glyphicon glyphicon-calendar"></span> <input type="text" readonly="true" class="datepicker" id="datepicker"></span>
		</div>
		<div class="row">
		<ul id="tabs" class="nav nav-tabs" data-tabs="tabs">
		        <li class="active"><a href="#list" data-toggle="tab">List</a></li>
		        <li><a href="#myevents" id="myeventslink" data-toggle="tab">My Events</a></li>
		        <li><a href="#map" data-toggle="tab" id="maplink">Map</a></li>
		</ul>
		    <div class="tab-content">
		    <div id="noeventsfortoday" class="alert alert-warning">No Events For Today!</div>
		        <div class="tab-pane active" id="list">

		        </div>
		        <div class="tab-pane" id="map">
		       		<div id="map-canvas"></div>
		        </div>
		        <div class="tab-pane" id="myevents">
		        </div>
		    </div>
		</div>
	</div>

	<script src="http://code.jquery.com/jquery.js"></script>
	<script src="js/bootstrap.min.js"></script>
	<script src="https://maps.googleapis.com/maps/api/js?v=3.exp&sensor=false"></script>
	<script src="http://code.jquery.com/ui/1.10.3/jquery-ui.js"></script>
	<script>
	serverURL = 'http://leserver.jacksonroberts.me/';
	function insertIntoList(data) {
		console.log(data);
		var event_string = "<h3>" + data.title + "</h3>";
		event_string += "<p> Address: " + data.address + "</p>";
		event_string += "<p> Date: " + data.date + "</p>";
		event_string += "<p> Description: " + data.description.slice(0,140) + "...</p>"
		event_string += "<a id=\"eventdetails\" href=\"#" + data.identifier + "\" class=\"btn btn-info\"><span class=\"glyphicon glyphicon-eye-open\"></span> More Info</a>";
		event_string += "<hr>";

		$('#list').append(event_string);
	}
	function loadMyEvents() {
		idList = JSON.parse(localStorage.goingList);
		for (i=0; i<idList.length; i++){
			var apiURL = serverURL + 'api/getevent/' + idList[i] + '/';
			$.getJSON(apiURL, function(data) {
				string = "<h3><a href=\"#" + data.identifier + "\" id='eventdetails'>" + data.title + "</a></h3>";
				$('#myevents').append(string);
			});
		}
	}
	function loadEvents(date) {
		$('#list').html('');
		if (typeof markers !== 'undefined') {
			for (var i = 0; i < markers.length; i++) {
				markers[i].setMap(null);
			}
			console.log('clearing');
		} else {
			markers = [];
		}
		if (typeof date == 'undefined') {
			var currentDate = new Date();
		} else {
			var splitDate = date.split('/');
			var currentDate = new Date(splitDate[2], splitDate[0] - 1, splitDate[1])
		}

		var year = currentDate.getFullYear();
		var month = currentDate.getMonth() + 1;
		var day = ('0' + currentDate.getDate()).slice('-2');

		var dateString = month + '/' + day + '/' + year;
		$('#datepicker').val(dateString);

		var apiURL = serverURL + 'api/getevents/' + year + '/' + month + '/' + day + '/';
		$.getJSON(apiURL, function(data) {
			function dropPin(latlng, title, id) {
				var marker = new google.maps.Marker({
					position: latlng,
					map: map,
					title: title,
					url: id,
				});
				markers.push(marker);
				console.log('dropped pin');
				google.maps.event.addListener(marker, 'click', function() {loadEventPage(marker.url);
				$('.row').hide();
				$('hr').hide();});
			}
			if (data.length != 0) {
				$('#noeventsfortoday').hide();
				console.log(data.length);
				for (var i=0; i<data.length; i++) {
					codeAddress(data[i], dropPin);
					insertIntoList(data[i]);
				}
			} else {
				$('#noeventsfortoday').show();
			}
		});
	}
	//do the main event loading
	var map;
	function initialize() {
		console.log(localStorage);
		if (typeof(localStorage.goingList) == 'undefined') {
			localStorage.goingList = '[]';
			console.log('made it');
		} else {
			console.log('didn');
		}
		geocoder = new google.maps.Geocoder();
		console.log('initialized map and geocoder');
	 	var mapOptions = {
	    	zoom: 13,
	    	mapTypeId: google.maps.MapTypeId.ROADMAP
	 	 };
		 map = new google.maps.Map(document.getElementById('map-canvas'),
	      mapOptions);
		 loadEvents();
		 loadMyEvents();
	}

	google.maps.event.addDomListener(window, 'load', initialize);

	function codeAddress(data, callback) {
		geocoder.geocode({'address': data.address}, function(results, status) {
			if (status == google.maps.GeocoderStatus.OK) {
				callback(results[0].geometry.location, data.title, data.identifier);
			}
		});
	}
	function loadEventPage(id) {
		console.log('LOADING FOR EVENT ' + id);
		var apiURL = serverURL + 'api/getevent/' + id + '/';
		$('#eventpage').show();
		$('#star').attr('class', 'glyphicon glyphicon-star-empty');
		$('#imgoing').attr('class', 'btn btn-lg btn-warning btn-block');
		$('#imgoing').attr('data-isactive', 'false');

		console.log(localStorage.goingList);
		goingList = JSON.parse(localStorage.goingList);

		if (goingList.indexOf(String(id)) > -1) {
			$('#star').attr('class', 'glyphicon glyphicon-star');
			$('#imgoing').attr('class', 'btn btn-lg btn-success btn-block');
			$('#imgoing').attr('data-isactive', 'true');
		}
		$.getJSON(apiURL, function(data) {
			console.log(data);
			$('#title').text(data.title);
			$('#address').append(data.address + '<br>' + '<a class="btn btn-success btn-sm" href="http://maps.apple.com/?q=' + data.address + '"><span class="glyphicon glyphicon-map-marker"></span> Open in Maps</a>');
			$('#date').append(data.date);
			$('#description').append(data.description);
			$('#imgoing').attr('data-id', id);
			if (data.going_count == 1) {
				var suffix = ' person is going.';
			} else {
				var suffix = ' people are going.'
			}
			$('#goingcount').text(data.going_count + suffix)
		});
	}
	$('#maplink').click(function() {
		setTimeout(function() {
			google.maps.event.trigger(map, 'resize');
			var latitude = 40.1639404;
			var longitude = -105.100502;
			var reCenter = new google.maps.LatLng(latitude, longitude);
			map.setCenter(reCenter);
			map.setZoom(12);
		}, 1);
	});
	var today = new Date();
	$("#datepicker").datepicker({
		onSelect: function(dateText) {
			loadEvents(dateText);
		},
		minDate: today,
	});
	$('#list').on("click", "#eventdetails", function() {
		$('.row').hide();
		$('hr').hide();
		var id = $(this).attr('href').substring(1);
		loadEventPage(id);
	});
	$('#myevents').on("click", "#eventdetails", function() {
		$('.row').hide();
		$('hr').hide();
		var id = $(this).attr('href').substring(1);
		loadEventPage(id);
	});
	$('#backbutton').click(function() {
		$('.row').show();
		$('hr').show();
		$('#eventpage').hide();

		$('#title, #address, #date, #description').html('');
	});
	$('#cal').click(function() {
		$('#datepicker').focus();
	});
	$('#imgoing').click(function() {
		if ($(this).attr('data-isactive') != 'true') {
			var apiURL = serverURL + 'api/imgoing/' + $(this).attr('data-id') + '/';
			$.getJSON(apiURL, function(data) {
				console.log(data);
			});
			$('#imgoing').attr('data-isactive', 'true');
			$('#star').attr('class', 'glyphicon glyphicon-star');
			$('#imgoing').attr('class', 'btn btn-lg btn-success btn-block');
			var newGoingCount = parseInt($('#goingcount').text()) + 1;
			if (newGoingCount == 1) {
				suffix = ' person is going.';
			} else {
				suffix = ' people are going.';
			}
			$('#goingcount').text(newGoingCount + suffix);
			goingList = JSON.parse(localStorage.goingList);
			goingList.push($(this).attr('data-id'));
			localStorage.goingList = JSON.stringify(goingList);
			localStorage.getItem('going-list');
			loadMyEvents();
		}
	})
	</script>
</body>
</html>